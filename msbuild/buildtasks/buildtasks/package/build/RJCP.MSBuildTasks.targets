<Project>
  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    Authenticode Signing
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <UsingTask TaskName="RJCP.MSBuildTasks.X509SignAuthenticode"
             AssemblyFile="$(MSBuildThisFileDirectory)RJCP.MSBuildTasks.dll" />

  <Target Name="X509SignAuthenticode" AfterTargets="Compile"
          Condition="'$(OS)' == 'Windows_NT' and '$(X509SigningCert)' != ''">
      <X509SignAuthenticode CertPath="$(X509SigningCert)"
                            TimeStampUri="$(X509TimeStampUri)"
                            InputAssembly="$(IntermediateOutputPath)$(TargetName)$(TargetExt)" />

      <X509SignAuthenticode CertPath="$(X509SigningCert)"
                            TimeStampUri="$(X509TimeStampUri)"
                            InputAssembly="$(AppHostIntermediatePath)"
                            Condition="'$(UseAppHost)' == 'true'" />
  </Target>

  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    Revision Control Meta-data
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

  <UsingTask TaskName="RJCP.MSBuildTasks.RevisionControl"
             AssemblyFile="$(MSBuildThisFileDirectory)RJCP.MSBuildTasks.dll" />
  <UsingTask TaskName="RJCP.MSBuildTasks.SemVer"
             AssemblyFile="$(MSBuildThisFileDirectory)RJCP.MSBuildTasks.dll" />

  <!-- The main target to hook into the build system automatically -->
  <Target Name="RevisionControlCheck" DependsOnTargets="$(RevisionControlDependsOn)"
          BeforeTargets="$(BeforeRevisionControl)" Condition="'$(RevisionControl)' != ''" />

  <Target Name="CoreRevisionControlCheck" >
    <RevisionControl Type="$(RevisionControl)" Path="$(MSBuildProjectDirectory)"
                     Label="$(RevisionControlLabel)" Strict="$(RevisionControlStrict)"
                     Cached="disabled">
      <Output TaskParameter="RevisionControlType" PropertyName="RevisionControlType" />
      <Output TaskParameter="RevisionControlBranch" PropertyName="RevisionControlBranch" />
      <Output TaskParameter="RevisionControlCommit" PropertyName="RevisionControlCommit" />
      <Output TaskParameter="RevisionControlCommitShort" PropertyName="RevisionControlCommitShort" />
      <Output TaskParameter="RevisionControlDateTime" PropertyName="RevisionControlDateTime" />
      <Output TaskParameter="RevisionControlDirty" PropertyName="RevisionControlDirty" />
      <Output TaskParameter="RevisionControlTagged" PropertyName="RevisionControlTagged" />
      <Output TaskParameter="RevisionControlHost" PropertyName="RevisionControlHost" />
      <Output TaskParameter="RevisionControlUser" PropertyName="RevisionControlUser" />
    </RevisionControl>

    <PropertyGroup>
      <SourceRevisionId Condition="'$(SourceRevisionId)' == ''">g$(RevisionControlCommitShort)</SourceRevisionId>
      <_RJCP_ReleaseBuild Condition="'$(Configuration)' == 'Release' and '$(RevisionControlDirty)' != 'true' and '$(RevisionControlTagged)' == 'true'">True</_RJCP_ReleaseBuild>
    </PropertyGroup>

    <SemVer Version="$(Version)">
      <Output TaskParameter="VersionBase" PropertyName="RevisionControlVersionBase" />
      <Output TaskParameter="VersionSuffix" PropertyName="RevisionControlVersionSuffix" />
      <Output TaskParameter="VersionMeta" PropertyName="RevisionControlVersionMeta" />
    </SemVer>

    <PropertyGroup Condition="'$(_RJCP_ReleaseBuild)' != 'True'">
      <Version Condition="'$(RevisionControlVersionSuffix)' == ''">$(RevisionControlVersionBase)-alpha.$(RevisionControlDateTime)</Version>
      <Version Condition="'$(RevisionControlVersionSuffix)' != ''">$(RevisionControlVersionBase)-$(RevisionControlVersionSuffix).$(RevisionControlDateTime)</Version>
      <PackageVersion>$(Version)</PackageVersion>
    </PropertyGroup>
  </Target>

</Project>